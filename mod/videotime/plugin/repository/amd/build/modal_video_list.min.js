define ("videotimeplugin_repository/modal_video_list",["jquery","core/notification","core/custom_interaction_events","core/modal","core/modal_registry","core/templates","core/ajax","core/modal_factory","core/modal_events","core/str","videotimeplugin_repository/select2","videotimeplugin_repository/pagination"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=!1,n=function(a){d.call(this,a);this.contextId=null;this.videos=[];this.videoPageIndex=[];this.descriptionModal=null;this.embedsModal=null;this.previewModal=null;this.confirmModal=null;this.query=null;this.filterData={};this.perPage=10;this.pagination=new l(this.perPage,0,a);this.pagination.init();this.sort=null;this.sortdirections={};this.readOnly=null};n.TYPE="video-list";n.prototype=Object.create(d.prototype);n.prototype.constructor=n;n.prototype.init=function(){this.pagination.getContainer().on("pagination.changePage",function(){this.refreshTable()}.bind(this));this.getConfirmModal(function(){});this.getPreviewModal(function(){})};n.prototype.setReadOnly=function(a){this.readOnly=a};n.prototype.setContextId=function(a){this.contextId=a};n.prototype.refreshTable=function(){var a={contextid:this.contextId,query:this.query,filter_data:this.filterData,limitfrom:this.pagination.getLimitFrom(),limitnum:this.perPage};if(this.sort){a.sort=this.sort;a.sortdirection=this.sortdirections[this.sort]}var b=g.call([{methodname:"videotimeplugin_repository_search_videos",args:a}]);b[0].done(function(a){a.data.forEach(function(a){this.videos[a.uri]=a;this.videoPageIndex[a.uri]=this.pagination.getCurrentPage()}.bind(this));var b=Object.assign(a,{readonly:this.readOnly});f.render("videotimeplugin_repository/video_table",b).then(function(b){this.pagination.setTotalItems(a.total);this.pagination.render("#pagination-container");this.getRoot().find(".video-list-table").html(b)}.bind(this))}.bind(this))};n.prototype.registerEventListeners=function(){d.prototype.registerEventListeners.call(this);this.getRoot().on(i.shown,function(){this.getModal().find(".select2").each(function(b,c){a(c).select2({dropdownParent:this.getRoot()})}.bind(this))}.bind(this));this.getModal().on(c.events.activate,"[data-action=use-video]",function(b){this.showConfirmModal(a(b.target).data("uri"))}.bind(this));this.getModal().on(c.events.activate,"[data-action=show-description]",function(b){this.showDescriptionModal(a(b.target).data("uri"))}.bind(this));this.getModal().on(c.events.activate,"[data-action=show-embeds]",function(b){this.showEmbedsModal(a(b.target).data("uri"))}.bind(this));this.getModal().on(c.events.activate,"[data-action=preview]",function(b){this.showPreviewModal(a(b.target).data("uri"))}.bind(this));this.getModal().on(c.events.activate,"[data-action=search]",function(b){this.setQuery(a(a(b.target).data("target")).val())}.bind(this));this.getModal().on(c.events.activate,"[data-action=clear-search]",function(b){this.query="";a(a(b.target).data("target")).val("");this.pagination.setCurrentPage(0);this.refreshTable()}.bind(this));this.getModal().on(c.events.activate,"[data-action=apply-filters]",function(){this.applyFilters()}.bind(this));this.getModal().on(c.events.activate,"[data-action=clear-filters]",function(b){this.filterData=[];a(a(b.target).data("target")).val("");this.getModal().find(".select2").val(null).trigger("change");this.pagination.setCurrentPage(0);this.refreshTable()}.bind(this));this.getModal().on(c.events.activate,"[data-action=sort]",function(b){this.sort=a(b.target).data("field");var c="ASC";if(this.sortdirections.hasOwnProperty(this.sort)){if("ASC"==this.sortdirections[this.sort]){c="DESC"}else{c="ASC"}}this.sortdirections[this.sort]=c;this.refreshTable()}.bind(this))};n.prototype.applyFilters=function(){this.filterData=this.getRoot().find("form").serializeArray();this.pagination.setCurrentPage(0);this.refreshTable()};n.prototype.useVideo=function(b,c){var d=this.videos[b];a("#id_vimeo_url").val(d.link);a("#id_vimeo_url").attr("readonly","readonly");a("#id_choose_video").html(d.name);a("#id_choose_video").val(d.name);a("#id_choose_video").addClass("btn-success");if(c){a("#id_name").val(d.name);a("#id_introeditor").val(d.description);a("#id_introeditoreditable").html(d.description);a("#id_completion_on_view_time_second").val(d.duration);a("#fitem_id_tags .form-autocomplete-selection").empty();a("#fitem_id_tags #id_tags").empty();a.each(d.tags,function(b,c){a("#fitem_id_tags #id_tags").append("<option data-iscustom=\"true\" value=\""+c.name+"\" selected>"+c.name+"</option>");a("#fitem_id_tags .form-autocomplete-selection").append("<span role=\"listitem\" data-value=\""+c.name+"\" aria-selected=\"true\" class=\"label label-info\"><span aria-hidden=\"true\">\xD7 </span>"+c.name+"</span>")})}this.hide()};n.prototype.showDescriptionModal=function(a){if(!this.videos.hasOwnProperty(a)){return}var b=this.videos[a];this.getDescriptionModal(function(a){a.setTitle(b.name);a.setBody(b.description);a.show()}.bind(this))};n.prototype.getDescriptionModal=function(a){if(!this.descriptionModal){h.create({}).done(function(b){this.descriptionModal=b;a(this.descriptionModal)}.bind(this))}else{a(this.descriptionModal)}};n.prototype.showEmbedsModal=function(a){if(!this.videos.hasOwnProperty(a)){return}var b=this.videos[a];j.get_string("embeds","videotime").done(function(a){this.getEmbedsModal(function(c){c.setTitle(b.name+" "+a);c.setBody(f.render("videotimeplugin_repository/embeds",{video:b}));c.show()}.bind(this))}.bind(this))};n.prototype.getEmbedsModal=function(a){if(!this.embedsModal){h.create({}).done(function(b){this.embedsModal=b;a(this.embedsModal)}.bind(this))}else{a(this.embedsModal)}};n.prototype.showPreviewModal=function(a){if(!this.videos.hasOwnProperty(a)){return}var b=this.videos[a];this.getPreviousAndNextVideoInSearch(a).then(function(a){j.get_string("preview","moodle").done(function(c){this.getPreviewModal(function(d){d.setTitle(b.name+" "+c);d.setBody(f.render("videotimeplugin_repository/preview_modal_body",{video:b,next_video:a.nextVideo,previous_video:a.previousVideo}));d.show()}.bind(this))}.bind(this))}.bind(this))};n.prototype.getPreviewModal=function(b){if(!this.previewModal){h.create({large:!0,footer:f.render("videotimeplugin_repository/preview_modal_footer",{readonly:this.readOnly})}).done(function(d){this.previewModal=d;d.getModal().on(c.events.activate,"[data-action=use-video]",function(){d.hide();this.showConfirmModal(d.getModal().find("#vimeo-embed").data("uri"))}.bind(this));d.getRoot().on(c.events.activate,"[data-action=preview]",function(b){this.showPreviewModal(a(b.target).data("uri"))}.bind(this));b(this.previewModal)}.bind(this))}else{b(this.previewModal)}};n.prototype.getPreviousAndNextVideoInSearch=function(a){var b=this,c=this.videoPageIndex[a],d=0;if(0<c){d=c*this.perPage-1}var e={contextid:this.contextId,query:this.query,filter_data:this.filterData,limitfrom:d,limitnum:this.perPage+2};if(this.sort){e.sort=this.sort;e.sortdirection=this.sortdirections[this.sort]}return new Promise(function(c){g.call([{methodname:"videotimeplugin_repository_search_videos",args:e}])[0].done(function(b){var e=null,f=null,g=null,h=!1;b.data.forEach(function(b,c){if(h){f=b;h=!1}if(b.uri===a){e=g;h=!0}this.videos[b.uri]=b;var i=Math.floor((d+c)/this.perPage);this.videoPageIndex[b.uri]=i;g=b}.bind(this));c({previousVideo:e,nextVideo:f})}.bind(b))})};n.prototype.showConfirmModal=function(a){if(!this.videos.hasOwnProperty(a)){return}var b=this.videos[a];j.get_strings([{key:"confirmation",component:"videotime"},{key:"choose_video_confirm",component:"videotime"}]).done(function(a){this.getConfirmModal(function(c){c.setTitle(a[0]);c.setBody("<p>"+a[1]+" \""+b.name+"\"?</p><input type=\"hidden\" name=\"uri\" value=\""+b.uri+"\">");c.show()}.bind(this))}.bind(this))};n.prototype.getConfirmModal=function(a){if(!this.confirmModal){h.create({footer:f.render("videotimeplugin_repository/confirm_modal_footer",{readonly:this.readOnly})}).done(function(b){this.confirmModal=b;b.getModal().on(c.events.activate,"[data-action=use-video]",function(){b.hide();var a=b.getModal().find("[name=uri]").val(),c=b.getModal().find("[name=override]").prop("checked");this.useVideo(a,c)}.bind(this));a(this.confirmModal)}.bind(this))}else{a(this.confirmModal)}};if(!m){e.register(n.TYPE,n,"videotimeplugin_repository/modal_video_list");m=!0}n.prototype.setFilterValue=function(a,b){this.getRoot().find("[name="+a+"]").val(b).trigger("change")};n.prototype.setQuery=function(a){this.getRoot().find("#search-input").val(a);this.query=a;this.pagination.setCurrentPage(0);this.refreshTable()};return n});
//# sourceMappingURL=modal_video_list.min.js.map
